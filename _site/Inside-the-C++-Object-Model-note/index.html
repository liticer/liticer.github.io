<!DOCTYPE html>
<html>
	<head>

		<title>You are best | MiKi</title>

	
	<meta name="description" content="阅读侯捷老师翻译的Lippman大作《Inside the C++ Object Mode》过程中，在自己理解和体会的基础上做了一些笔记。">
	

	<meta name="uyan_auth" content="d1688267ba" />
	<meta name="ujianVerification" content="a95a574e56de0fa5e1eaafdd30f676aa" />
	<meta property="wb:webmaster" content="c8ddfcbeabe108f4" />
	<meta name="author" content="MiKi Shi">
	<meta charset="utf-8" />

		<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" type="text/css" href="/assets/css/style.css">
<link rel="stylesheet" type="text/css" href="/assets/resources/syntax/syntax.css">
<link rel="stylesheet" type="text/css" href="/assets/resources/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/assets/resources/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/assets/themes/prettify/prettify.css" media="all">
<link rel="icon" href="../assets/media/favicon.jpg">

<link href='http://fonts.googleapis.com/css?family=Raleway:300' rel='stylesheet' type='text/css'>

<script type="text/javascript" src="/assets/js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.js"></script>


	</head>
<body>

<nav class="navbar navbar-default visible-xs" role="navigation">


 <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbarHeaderCollapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a type="button" class="navbar-toggle nav-link" href="http://github.com/liticer">
        <i class="fa fa-github"></i>
      </a>
      
      
       
      <a type="button" class="navbar-toggle nav-link" href="mailto:shijh09@sina.com">
        <i class="fa fa-envelope"></i>
      </a>
      



      <a class="navbar-brand" href="">
        <img src="../assets/media/me.jpg" class="img-circle" style="height:35px;width:35px"/>
        MiKi Shi
      </a>
    </div>


    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbarHeaderCollapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="">Home</a></li>
        <li><a href="/categories.html">Categories</a></li>
        <li><a href="/tags.html">Tags</a></li>
        <li><a href="/me.html">About Me</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->

</nav>

  <!-- nav-menu-dropdown -->
  <div class="btn-group hidden-xs" id="nav-menu">
   <button type="button" class="btn btn-default dropdown-toggle pull-right" data-toggle="dropdown">
     <i class="fa fa-bars"></i>
   </button>
   <ul class="dropdown-menu pull-right" role="menu">
     <li><a href=""><i class="fa fa-home"></i> Home</a></li>
	 <li><a href="/#blog"><i class="fa fa-bars"></i> Blog</a></li>
     <li><a href="/categories.html"><i class="fa fa-folder"></i> Categories</a></li>
     <li><a href="/tags.html"><i class="fa fa-tags"></i> Tags</a></li>
     <li><a href="/me.html"><i class="fa fa-envelope"></i> About Me</a></li>
     <li class="divider"></li>
     <li><a href="#"><i class="fa fa-arrow-up"></i> Top of Page</a></li>
   </ul>
 </div>

<div class="col-sm-4 sidebar hidden-xs" id="sidebar">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
    <a href="">
        <img src="../assets/media/me.jpg" class="img-circle" style="border-radius: 50%;
border: 3px solid #FFF; height:150px;width:150px"/>
    </a>

    <h3 class="title">
        <a href="/me.html" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">MiKi Shi</a>

        <p style="font-size:20px;font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">Programmer</p>
    </h3>

    <hr class="hr-line">
    <h5 class="title">
        <a type="button" class="social2" id="btnblog" href="/#blog">
            <i class="fa"
            style="letter-spacing:0; position:relative; top:-5px; left: -5px; font-size:20px;font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">博客</i>
        </a>
    </h5>

    <hr class="hr-line1">
    <h3 class="title" style="font-size:30px;font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">

        <a type="button" class="social1" href="http://github.com/liticer">
            <i class="fa fa-github"></i>
        </a>

        <a type="button" class="social1" href="https://www.facebook.com/liticer">
            <i class="fa fa-facebook"></i>
        </a>
        <a type="button" class="social1" href="https://cn.linkedin.com/pub/liticer"
                style="padding-right: 10px">
            <i class="fa fa-linkedin"></i>
        </a>

    </h3>

</header>


<! -- sidebar.html end -->

	</div>

<div class="col-sm-8 col-sm-offset-4" id="container">
  
<div class="page-header">
  <h1>深度探索C++对象模型学习笔记 </h1>
</div>

<article>

  <div class="col-sm-10">
   <span class="post-date" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">
     
     December 
     2nd,
       
     2015
      
   </span>
    <div class="article_body" id="article_body">
    <h2 id="font-colorblue1-font"><font color="blue">第1章 关于对象</font></h2>

<p>1. C++对象的布局成本<br /></p>

<ul>
  <li>C++中单纯地使用封装和继承，并不会增加存取时间和存储空间上的成本。</li>
  <li>C++真正需要的额外成本是由Virtual引起的(包括Virtual function和Virtual base class)。</li>
</ul>

<p>2. C++对象模型<br /></p>

<ul>
  <li>数据成员：Nonstatic data members被配置于每一个class object之内；Static data members 被存放在个别的class object之外。</li>
  <li>非虚函数成员：Nostatic/Static function members均被置于个别的class object 之外，同一般的非成员函数处理机制类似。</li>
  <li>虚函数成员：
    <ul>
      <li>每一个class产生出一堆指向virtual functions的指针，存放在一个叫做virtual table(vtbl)的表格之中。通常一个class所关联的type_info object被存放在该表格的第一个slot中。</li>
      <li>每一个class object被安插一个叫做virtual pointer(vptr)的指针，指向相关的virtual table。通常vptr会被每一个class的constructor、destructor和copy assignment等函数自动地进行设定和重置。</li>
    </ul>
  </li>
</ul>

<h2 id="font-colorblue2-font"><font color="blue">第2章 构造函数语意学</font></h2>

<p>1. Default Constructor的构造操作<br /></p>

<p>    对于一个类，如果没有任何user-declared constructor，那么在编译器有需要的时候，会为它合成一个nontrival default constructor。通常，有如下4种情况需要合成copy constructor:</p>

<ul>
  <li>该class有”带Default Constructor”的Data member
    <ul>
      <li>需要在构造函数中调用该Data member的默认构造函数初始化该成员。</li>
    </ul>
  </li>
  <li>该class有”带Default Constructor”的Base class
    <ul>
      <li>需要在构造函数中调用Base class的默认构造函数初始化Base class subobject。</li>
    </ul>
  </li>
  <li>该class有”Virtual Function”
    <ul>
      <li>需要在构造函数中生成或维护vtbl，并设置或修改vptr。</li>
    </ul>
  </li>
  <li>该class有”Virtual base class”
    <ul>
      <li>需要在构造函数中维护vtbl和vptr，保证virtual base class在每一个derived class object中的位置在执行期准备妥当。</li>
    </ul>
  </li>
</ul>

<p>    至于没有存在上述4种情况且没有声明任何constructor的class，我们说它拥有的是implicit trivial default constructor，它们实际上不会被合成出来。</p>

<p>    C++新手一般有两个常见的误解：
(1)任何class，如果没有定义default constructor，就会被合成出来一个。
(2)编译器默认合成出来的default constructor会显式地设定”class内每一个data member的默认值”。</p>

<p>2. Copy Constructor的构造操作<br /></p>

<p>    调用Copy constructor三种情况分别是：初始化、传参和返回值。和default construtor一样，copy constructor也分为trivial和nontrivial两种，只有nontrivial的class才会合成它。倘若一个class展现出所谓的”bitwise copy semantics”，那么它的copy constructor就是trivival的。一个class不展现出”bitwise copy semantics”的4种情况如下：<br /></p>

<ul>
  <li>当class内含有一个member object，而后者的class声明有一个copy constructor时(不论是被class设计者显式声明，还是被编译器合成都算)，该class的copy constructor需要调用该member object的copy constructor完成该成员的拷贝构造。</li>
  <li>当class继承自一个base class，而后者存在一个显式声明的copy constructor时，该class的copy constructor需要调用base class的copy constructor完成base class subobject的拷贝构造。</li>
  <li>当class声明了一个或多个virtual functions时，该class的copy constructor需要维护vptr指针，保证其指向对应的class的vtbl。</li>
  <li>当class派生于一个继承串链，其中有一个或多个virtual base classes时，该class的copy constructor需要拷贝构造virtual base subobject，同时维护vptr指针确保其指向对应的class的vtbl。</li>
</ul>

<p>3. 程序转化语意学<br /></p>

<ul>
  <li>参数初始化：在非引用参数传入之前，可能会先创建一个临时变量存储参数。然后在调用函数时以引用方式传入这个临时变量，当然函数的声明也会做相应的修改。</li>
  <li>返回值初始化：如果函数的返回值不是引用变量，会在函数调用前创建一个临时变量存储返回值。然后在调用函数时以引用方式传入这个临时变量，当然函数的声明也会作相应的修改。</li>
  <li>使用者层面的优化：如果函数的返回值不是引用变量，则在函数return时创建临时变量比在函数开始处创建临时变量要好，有可能会减少一次copy constructor的调用。如果不懂，可以联系上一条结论理解。</li>
  <li>编译器层面的优化：如果函数中所有return指令传回相同的变量，编译器有可能会以返回值result参数取代named return value, 这个过程也被叫做NRV优化。</li>
  <li>Copy constructor的取舍：当class的default copy constructor被时为trivial的时候，一般情况下不需要为其提供emplicit的copy constructor。然而如果class需要大量的memberwise的初始化操作，那么就可以给它提供一个copy constructor；一方面结合编译器作NRV优化，另一方面可以用memcpy函数提高拷贝效率。</li>
</ul>

<p>4. 成员初始化<br /></p>

<ul>
  <li>Member initialization list必需的情况：初始化一个reference member；初始化一个const member；初始化member object时需要调用含参构造函数；初始化base class时需要调用含参构造函数。</li>
  <li>Member initialization list的初始化顺序：一个object的构造总是先构造其base subobject部分，而member的初始化总是要按顺序被安插在任何explicit user code之前。在每一个constrctor中的member初始化时，需要先调用base class的constructor，然后在按成员在class中的顺序逐一初始化各个成员，最后执行explicit user code
。</li>
  <li>初始化的一些特殊情况：以member function的结果初始化member; 以member function的结果作为base class constructor的参数。Member function的调用是合法的，因为在object相关的this指针在构建时已经准备妥当，但还是要尽量避免上述情况。具体原因时，构造函数调用前，object的data member有可能还未被全部初始化；而在调用构造base class subobject时，通过this指针调用虚函数时将有可能发生异常的动态绑定过程。</li>
</ul>

<h2 id="font-colorblue3-datafont"><font color="blue">第3章 Data语意学</font></h2>

<p>1. Data member的绑定<br />
    编译器对于一个inline member function的本体的分析，会在整个class的声明都出现了才开始；然而对于member function的argument list，则是在它们第一次出现时被适当地进行决议完成的。因此上，在现代C++程序设计中，需要将”nested type声明”放在class的起始处，这是一种安全的防御性程序设计风格。</p>

<p>2. Data member的布局<br />
    C++ Standard要求，在同一个access session中，较晚出现的members在class object中有较高的地址。同时，编译器还可能会合成一些内部使用的data member(如vptr)，传统上它们通常被放在所有显式声明的members之前或者之后。</p>

<p>3. Data member的存取<br /></p>

<ul>
  <li>
    <p>Static data members对每个class来说只有一个实例，存放在从class之外的data segment中，并被视为一个global变量；不论通过实例访问，还是通过类名访问，都会在内部被转化成类名的访问形式。</p>
  </li>
  <li>
    <p>Nonstatic data members直接存放在每一个object当中。每一个nonstatic data member的偏移位置在编译时期即可获知，因此存取一个nonstatic data member的效率和存取一个C struct member的效率是一样的。唯一的例外是，当使用指针或引用访问member时，该指针或引用指向的class的继承结构中有一个virtual base class，且该member是从该virtual base class继承而来的。这种情况下，因为不知道该指针或引用指向哪一种class type，因此存取操作必须延迟至执行期，经由一个额外的间接引导才能解决。</p>
  </li>
</ul>

<p>4. 继承与data member<br /></p>

<ul>
  <li>单一继承不含virtual functions：
    <ul>
      <li>一个object由两部分构成，base class subobject和本身的data members。这种情况下并不会增加空间或者时间上的额外负担。</li>
    </ul>
  </li>
  <li>单一继承且含virtual functions：
    <ul>
      <li>为每一个class导入一个virtual table，用来存放它所声明的每一个virtual function的地址。</li>
      <li>在每一个class object种导入一个vptr，提供执行期的链接，使每一个object都能找到相应的virtual table。对base class来说，vptr在object中的位置通常在所有data members之后；而derived class object会继承base class的vptr，不用单独再留存储空间。</li>
      <li>加强constructor，使它能够为vptr设定初值，让它指向class所对应的virtual table。这可能意味者在derived class和每一个base class的constructor中，会重新设定vptr的值。</li>
      <li>加强destructor，使它能够矫正vptr，让它指向class所对应的virtual table。因为，vptr很可能已经在derived class destructor中被设定为derived class的virtual table的地址了。</li>
    </ul>
  </li>
  <li>多重继承：
    <ul>
      <li>对于多重继承来说，一个derived class object由几部分组成：base class1 subobject, base class2 subobject, …, data members。在这种情况下，把一个derived object转换为其base类型，就需要编译器的介入，用以调整地址。</li>
      <li>多重继承的情况下，如果一个derived class object有vptr，那么其vptr就存放在其继承列表中第一个含有vptr的subobject的vptr处，否则在data members之后新增一个vptr域。</li>
    </ul>
  </li>
  <li>虚拟继承：
    <ul>
      <li>对于虚拟继承来说，它跟多重继承的情况类似。只是它需要指出shared base subobject的偏移位置，而这个偏移量通常会被放置在virtual table最前面的slot中。在将derived object赋值给base object时，需要通过virtual table查找这个偏移量，并进行复制构造。</li>
      <li>当通过object来存取一个从virtual base class的member，可以被优化成一个直接存取操作；然而通过指针或引用来访问上述member时，就需要在执行期通过查找virtual table中的offset，经过两次间接引导才能访问到。因此上，virtual base class最有效的一种运用形式就是：一个抽象的virtual base class，没有任何的data member。</li>
    </ul>
  </li>
</ul>

<p>5. 指向data members的指针<br /></p>

<ul>
  <li>对class的nonstatic member取地址得到的是一个偏移值，表示该member在class中的偏移位置，可以将该值赋给一个指向该class的data member的指针；而对object的nonstatic member取地址得到的是一个地址值，表示该object中的data member的地址，可以将该值赋给一个指向该member类型的指针。</li>
  <li>对class或者object中的static member取地址得到的是一个地址值，表示该class中static member的在内存中的位置，可以将该值赋给一个指向该member类型的指针。</li>
  <li>为了区分一个”没有指向任何data member的指针”和”一个指向第一个data member的指针”，每一个真正的member offset值都会被加上1，而在使用该offset取值之前，需要减掉1。</li>
</ul>

<h2 id="font-colorblue4-function-font"><font color="blue">第4章 Function 语意学</font></h2>

<p>
<font color="blue"><strong>
</strong></font>
</p>

<p><a href="https://github.com/liticer/zhihu_python">https://github.com/liticer/zhihu_python</a> <br /></p>
<p />

<p><br /></p>

<p><strong>附: <a href="/assets/source/zhihu.py" download="">zhihu.py</a> </strong></p>

<pre class="prettyPrint lang=python">
</pre>


    </div>

    
    <ul class="tag_box list-unstyled list-inline">
      <li><i class="fa fa-folder-open"></i></li>
      
      
      
        <li><a href="/categories.html#cpp-ref" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">
          cpp <span>(1)</span>
          
        </a></li>
      
      
    </ul>
    

    
    <ul class="list-inline">
      <li><i class="fa fa-tags"></i></li>
      
      
      
        <li>
          <a href="/tags.html#Object-ref" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">
          Object <span>(1)</span>
          ,
          </a>
        </li>
      
        <li>
          <a href="/tags.html#Model-ref" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">
          Model <span>(1)</span>
          
          </a>
        </li>
      
      
      
    </ul>
    

    <hr>

    <div>
      <section class="share col-sm-6">
        <h4 class="section-title" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=深度探索C++对象模型学习笔记"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-weixin fa-lg"></i>
          Wechat
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="../assets/media/me.jpg" style="height:100px;width:100px;" class="img-rounded author-image" />
        <h4 class="section-title author-name" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;"><b>MiKi Shi</b><br/><p style="color:#888;font-size:13px;">Programmer</p></h4>
        <p class="author-bio" style="font-family: 'Comic Sans MS',Verdana,Consolas,'Hiragino Sans GB',SimSun,Arial;">Talk is cheap, show me the code!</p>
      </section>
    </div>

    <div class="clearfix"></div>

    <ul class="pager">
      
      <li class="previous"><a href="/Python-API-for-ZhiHu-04" title="Python爬虫遇上知乎(六)">&larr; 上一篇</a></li>
      
      
      <li class="next disabled"><a>下一篇 &rarr;</a>
      
    </ul>

  </div>
    <!-- UY BEGIN -->
    <div id="uyan_frame" class="col-sm-10"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2072524"></script>
    <!-- UY END -->

</article>
<div class="clearfix"></div>


<footer class="navbar navbar-default">
    <div class="container">
      <p class="navbar-text pull-left">Some rights reserved &copy; 2015 MiKi Shi. </br>
      如有任何疑问请发送邮件至 <a class="navbar-button" href="http://gmail.google.com/">shijh09@gmail.com</a></p>
 </div>
  </footer>
</div>

<script type="text/javascript" src="/assets/themes/prettify/prettify.js"></script>
<script type="text/javascript">
    // 需要引入jQuery
    $(document).ready(function() {
        $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto');
        prettyPrint();
    });
</script>

</body>
</html>
